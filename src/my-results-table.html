<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<script src="../bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="shared-styles.html">

<dom-module id="my-results-table">
  <template>
    <style include="shared-styles">
       :host {
        display: block;
        padding: 10px;
        --vaadin-grid-row-height: 100px;
      }
    </style>
    <custom-style>
      <style>
      vaadin-grid {
        -webkit-user-select: text;
        -moz-user-select: text;
        -ms-user-select: text;
        user-select: text;
      }
      </style>
    </custom-style>

    <div class="card wideLay">
      <h1>Results</h1>
      <vaadin-grid id="mainGrid" items="[[documents]]" rows="20" selection-mode="multi" onchange="">
        <table id="mainTable">
          <colgroup>
            <col id="_source.Barcode" name="_source.Barcode" sortable="" />
            <col name="_source.FileName" sortable="" />
            <col name="_source.total" sortable="" />
            <col name="_source.imageUrl" />
            <col name="_source.getTiff" />
            <col name="_source.Path" />
            <col name="_id" hidden/>
          </colgroup>
          <thead>
            <tr>
              <th>Barcode</th>
              <th>File Name</th>
              <th>Group Count</th>
              <th>Thumb</th>
              <th>Path</th>
            </tr>
            <tr>
              <th></th>
              <th>
              </th>
            </tr>
          </thead>

        </table>
      </vaadin-grid>
    </div>
  </template>
  <script>
    var filterElement = document.createElement("paper-input");
    filterElement.setAttribute("type", "search");
    filterElement.setAttribute("placeholder", "Filter...");
    filterElement.style.width = "100%";


    HTMLImports.whenReady(function() {

      Polymer({
        is: 'my-results-table',
        properties: {
          'documents': {
            type: Array
          },
          'selectedIds': {
            type: Array,
            notify: true,
            value: []
          },
          'filteredDocs': {
            type: Array,
            notify: true,
            value: []
          }
        },
        attached: function() {
          var grid = this.$.mainGrid;
          var self = this;
          var selectedIds = [];
          var filter = this.$.fileFilter;
          var _THIS = this;
          grid.then(function() {
            var gridItems = grid.items;
            ////

            grid.header.getCell(1, 0).content = filterElement;

            var timer = 0;

            function filter() {
              console.log("refreshing grid")
              clearTimeout(timer);
              timer = setTimeout(grid.refreshItems.bind(grid), 500);
              console.log(grid.items.length);
              if (filterData.length != 0) {
                grid.items = filterData;
              }
            };

            filterElement.addEventListener("keyup", filter);
            filterElement.addEventListener("click", filter);


            filterData = function(params, callback) {
              console.log("updating grid")
              var filterValue = filterElement.value.toLowerCase();
              var data = gridItems.filter(function(val) {
                return (val._source.FileName.toString().toLowerCase()).indexOf(filterValue) > -1
              });
              console.log(data)
              var slice = data.slice(params.index, params.index + params.count);
              callback(slice, data.length);
            };
            ////
            grid.columns[3].renderer = function(cell) {
              cell.element.innerHTML = cell.data;
            };
            grid.columns[4].renderer = function(cell) {
              cell.element.innerHTML = cell.data;
            };
            grid.addEventListener('selected-items-changed', function() {
              selectedIds = [];
              grid.selection.selected(function(index) {
                selectedIds.push(grid.items[index]._id)
              });
              _THIS.set(`selectedIds`, selectedIds)
            });
            // Re-order the data array on sort-order-changed event
            grid.addEventListener('sort-order-changed', function(e) {
              grid.items = gridItems;
              e.preventDefault();
              console.log(e.detail)
              console.log('grid items for sort are' + grid.items)
              var idx = e.detail.value[0].column;
              var columnList = ["Barcode", "FileName", "total"]
              var colName = columnList[idx];
              console.log(`${colName}`)
              var lesser = grid.sortOrder[0].direction == 'asc' ? -1 : 1;
              grid.items.sort(function(a, b) {
                return (a._source[colName] < b._source[colName]) ? lesser : -lesser;
              });
            });
          })
        }
      })
    });
  </script>
</dom-module>
